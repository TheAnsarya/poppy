# 🚀 Poppy Compiler v2.0 Roadmap

**Target Release:** Q4 2026 - Q1 2027
**Vision:** Universal retro gaming assembler with modern tooling

---

## 🎯 v2.0 Overview

Version 2.0 represents a major expansion of Poppy's capabilities:

- **Additional Platforms** - GBA, Genesis/Mega Drive, SPC700
- **Modern Tooling** - LSP, web compiler, plugin system
- **Advanced Features** - Optimizer, linker, library system
- **Alternative Syntax** - Support for other assembler syntaxes

---

## 🎮 New Platform Support

### Game Boy Advance (ARM7TDMI)

**Status:** Planned for v2.0.0
**Instruction Set:** ARMv4T (ARM + Thumb)

#### Features

- [ ] **ARM Instructions** - 32-bit instruction set
	- Data processing (ADD, SUB, MOV, etc.)
	- Multiply and multiply-accumulate
	- Load/store (single and multiple)
	- Branch and branch-with-link
	- Coprocessor instructions (unused on GBA)

- [ ] **Thumb Instructions** - 16-bit instruction set
	- Data processing subset
	- Load/store optimizations
	- Branch instructions
	- ARM/Thumb mode switching

- [ ] **GBA ROM Generation**
	- GBA ROM header at $000
	- Nintendo logo and checksum
	- Entry point configuration
	- Multiboot support

- [ ] **GBA-Specific Features**
	- IWRAM/EWRAM sections
	- ROM/SRAM sections
	- OAM/Palette/VRAM addressing
	- Interrupt handling

#### Syntax Example

```asm
.target gba

.section iwram
.align 4
wait_vblank:
	mov r0, #0x04000000    ; IO base
	ldr r1, [r0, #0x04]    ; DISPSTAT
-	tst r1, #1             ; VBlank flag
	beq -
	bx lr

.section rom
.org 0x08000000
start:
	mov sp, #0x03007f00    ; Setup stack
	bl wait_vblank
	b start
```

---

### Sega Genesis / Mega Drive (Motorola 68000)

**Status:** Planned for v2.0.0
**Instruction Set:** 68000

#### Features

- [ ] **68000 Instructions** - Complete instruction set
	- Data movement (MOVE, MOVEM, etc.)
	- Arithmetic and logic (ADD, SUB, AND, OR)
	- Shift and rotate
	- Bit manipulation
	- Program control (BRA, Bcc, JSR, RTS)

- [ ] **Addressing Modes** - All 14 modes
	- Data register direct (Dn)
	- Address register direct (An)
	- Address register indirect (An)
	- Postincrement/predecrement
	- Displacement modes
	- Indexed modes
	- Absolute addressing
	- Immediate data

- [ ] **Genesis ROM Generation**
	- Vector table at $000
	- ROM header at $100
	- SEGA string and checksum
	- Region codes
	- Copyright notice

- [ ] **Genesis-Specific Features**
	- Z80 sound driver support
	- VDP register definitions
	- Controller I/O
	- DMA helpers

#### Syntax Example

```asm
.target genesis

.org $000000
vectors:
	dc.l $00fffe00         ; Initial SP
	dc.l start             ; Entry point
	dc.l bus_error         ; Bus error
	; ... more vectors ...

.org $000100
header:
	dc.b "SEGA MEGA DRIVE "
	dc.b "(C)2026 "
	dc.b "MY GAME TITLE                    "
	; ... rest of header ...

start:
	move.w #$2700, sr      ; Disable interrupts
	move.l #vblank, $70    ; Setup VBlank vector
	; ... initialization ...
```

---

### SNES SPC700 (Audio Processor)

**Status:** Planned for v2.1.0
**Instruction Set:** SPC700 (Sony)

#### Features

- [ ] **SPC700 Instructions** - Audio CPU instruction set
	- 8-bit accumulator operations
	- 16-bit register operations
	- Memory addressing modes
	- Bit manipulation
	- Direct page addressing

- [ ] **SPC File Generation**
	- SPC file format export
	- IPL ROM support
	- RAM initialization
	- Register state

- [ ] **Audio Features**
	- DSP register access
	- Sample playback
	- Echo buffer setup
	- BRR sample support

#### Syntax Example

```asm
.target spc700

.org $0200
start:
	mov x, #$00
	mov sp, #$01ff
	call init_dsp
	
init_dsp:
	mov a, #$0c            ; Main volume left
	mov $f2, a
	mov a, #$ff
	mov $f3, a
	ret
```

---

## 🛠️ Modern Tooling

### Language Server Protocol (LSP)

**Status:** Planned for v2.0.0

#### Features

- [ ] **Cross-Platform Support** - Works with any LSP client
	- VS Code (via extension)
	- Vim/Neovim (via coc.nvim, nvim-lsp)
	- Emacs (via lsp-mode)
	- Sublime Text
	- Any editor with LSP support

- [ ] **Language Features**
	- Real-time diagnostics
	- Code completion
	- Go to definition
	- Find references
	- Hover information
	- Signature help
	- Document symbols
	- Workspace symbols
	- Code actions (quick fixes)

- [ ] **Advanced Features**
	- Call hierarchy
	- Type hierarchy (for structs)
	- Inlay hints (addressing modes, sizes)
	- Semantic highlighting
	- Code lens (show symbol usage)

#### Architecture

```
┌─────────────┐
│   Editor    │ ← LSP client
│  (VS Code)  │
└──────┬──────┘
       │ JSON-RPC
       │
┌──────▼──────┐
│ Poppy LSP   │ ← Language server
│   Server    │
└──────┬──────┘
       │
┌──────▼──────┐
│   Poppy     │ ← Compiler API
│  Compiler   │
└─────────────┘
```

---

### Web-Based Compiler (WASM)

**Status:** Planned for v2.0.0

#### Features

- [ ] **Browser-Based Compilation** - Compile in the browser
	- No installation required
	- Instant feedback
	- Share code via URL
	- Educational use

- [ ] **WebAssembly Target** - Compile Poppy to WASM
	- Full compiler functionality
	- Lexer, parser, code generator
	- ROM generation
	- Symbol export

- [ ] **Web IDE** - Online development environment
	- Code editor (Monaco/CodeMirror)
	- Syntax highlighting
	- Emulator integration (JSNES, snes9x.js, gambatte)
	- Download compiled ROMs

#### Example

Visit `https://poppy-compiler.dev` → Write code → Compile → Test in emulator

---

### Plugin System

**Status:** Planned for v2.1.0

#### Features

- [ ] **Custom Directives** - Add new directives
	```csharp
	[PoppyDirective("custom_data")]
	public class CustomDataDirective : IDirective {
		public void Process(DirectiveContext context) {
			// Custom logic
		}
	}
	```

- [ ] **Custom Code Generators** - Add platforms
	```csharp
	[CodeGenerator("z80")]
	public class Z80Generator : ICodeGenerator {
		public byte[] Generate(ASTNode node) {
			// Z80 code generation
		}
	}
	```

- [ ] **Custom Analyzers** - Add validation
	```csharp
	[Analyzer("timing")]
	public class TimingAnalyzer : IAnalyzer {
		public void Analyze(CompilationUnit unit) {
			// Check timing constraints
		}
	}
	```

- [ ] **Plugin Manager** - Install/manage plugins
	```bash
	poppy plugin install timing-analyzer
	poppy plugin list
	poppy plugin update
	```

---

## 🔧 Advanced Features

### Optimizing Compiler

**Status:** Planned for v2.0.0

#### Optimization Passes

- [ ] **Dead Code Elimination**
	```asm
	; Before
	lda #$00
	lda #$01    ; Dead store
	
	; After
	lda #$01
	```

- [ ] **Constant Folding**
	```asm
	; Before
	lda #5 + 3
	
	; After
	lda #8
	```

- [ ] **Peephole Optimization**
	```asm
	; Before
	lda #$00
	sta $2000
	lda #$00
	sta $2001
	
	; After
	lda #$00
	sta $2000
	sta $2001
	```

- [ ] **Register Allocation** - Better register usage
- [ ] **Branch Optimization** - Convert long branches
- [ ] **Addressing Mode Selection** - Choose optimal mode

---

### Linker

**Status:** Planned for v2.0.0

#### Features

- [ ] **Separate Compilation** - Compile files independently
	```bash
	poppy compile main.pasm -o main.o
	poppy compile engine.pasm -o engine.o
	poppy link main.o engine.o -o game.nes
	```

- [ ] **Object File Format** - Relocatable object files
	- Symbol tables
	- Relocation information
	- Section data

- [ ] **Library Support** - Link against libraries
	```bash
	poppy link game.o -l nes-stdlib -l music-engine -o game.nes
	```

- [ ] **Dynamic Linking** - Runtime loading (for some platforms)

---

### Library System

**Status:** Planned for v2.1.0

#### Features

- [ ] **Standard Library** - Common routines
	- Math functions (multiply, divide, sqrt)
	- String operations
	- Memory management
	- Controller input
	- PPU/VDP helpers

- [ ] **Package Manager** - Install libraries
	```bash
	poppy install nes-stdlib
	poppy install snes-graphics
	poppy install gb-audio
	```

- [ ] **Library Repository** - Central package repository
	- Browse packages
	- Version management
	- Dependency resolution

#### Example

```asm
.import "nes-stdlib/math"
.import "nes-stdlib/controller"

	; Use library functions
	call math.multiply      ; 8x8 multiply
	call controller.read    ; Read controller state
```

---

## 🎨 Alternative Syntax Modes

### ASAR Compatibility Mode

**Status:** Planned for v2.0.0

#### Features

- [ ] **ASAR Syntax** - Compatible with ASAR assembler
	```asm
	org $808000
	
	LDA #$00
	STA $2100
	
	db $01,$02,$03
	```

- [ ] **Directive Mapping** - Map ASAR directives to Poppy
	- `org` → `.org`
	- `db` → `.byte`
	- `dw` → `.word`
	- `macro` → `.macro`

- [ ] **Migration Path** - Convert ASAR to Poppy syntax
	```bash
	poppy convert --from=asar --to=poppy game.asm -o game.pasm
	```

---

### ca65 Compatibility Mode

**Status:** Planned for v2.0.0

#### Features

- [ ] **ca65 Syntax** - Compatible with ca65 assembler
	```asm
	.segment "CODE"
	
	.proc reset
		lda #$00
		sta $2000
		rts
	.endproc
	```

- [ ] **Segment Support** - ca65-style segments
- [ ] **Scope System** - .proc/.scope support
- [ ] **Configuration Files** - ld65 config support

---

## 📊 v2.0 Milestone Breakdown

### v2.0.0 - Platform Expansion (Q4 2026)

- [ ] GBA support (ARM7TDMI)
- [ ] Genesis support (68000)
- [ ] LSP server implementation
- [ ] Web compiler (WASM)
- [ ] Optimizing compiler
- [ ] Linker system
- [ ] ASAR compatibility mode
- [ ] ca65 compatibility mode

**Estimated Effort:** 4-5 months

---

### v2.1.0 - Advanced Tooling (Q1 2027)

- [ ] SPC700 support (SNES audio)
- [ ] Plugin system
- [ ] Library system and package manager
- [ ] Advanced debugging features
- [ ] Performance profiler
- [ ] Coverage analysis

**Estimated Effort:** 2-3 months

---

### v2.2.0 - Polish & Performance (Q2 2027)

- [ ] Parallel compilation
- [ ] Cloud compilation service
- [ ] CI/CD integration helpers
- [ ] Advanced error recovery
- [ ] Internationalization (i18n)

**Estimated Effort:** 2 months

---

## 🎯 Success Metrics for v2.0

- ✅ Compile for 6+ platforms (NES, SNES, GB, GBA, Genesis, SPC700)
- ✅ LSP working in 3+ editors (VS Code, Vim, Emacs)
- ✅ Web compiler handles 90% of use cases
- ✅ Plugin system with 10+ community plugins
- ✅ Standard library covering 80% of common needs
- ✅ 50% faster compilation than v1.x
- ✅ 100% ASAR/ca65 syntax compatibility

---

## 🔮 Beyond v2.x

### Potential Features for v3.0+

- **Additional Platforms**
	- Neo Geo (68000 + Z80)
	- Nintendo 64 (MIPS R4300i)
	- PlayStation 1 (MIPS R3000)
	- Atari 2600 (6507)
	- Commodore 64 (6510)

- **Advanced Language Features**
	- Object-oriented assembly
	- Generic/template macros
	- Type system for safety
	- Formal verification

- **Development Tools**
	- Integrated profiler
	- Memory leak detector
	- Automated testing framework
	- Benchmark suite

---

## 📝 Contributing to v2.0

Want to help build v2.0?

1. Check [v2.0 GitHub Project](https://github.com/TheAnsarya/poppy/projects/2)
2. Read [CONTRIBUTING.md](../CONTRIBUTING.md)
3. Pick an issue labeled `v2.0`
4. Submit a PR with tests

---

**Last Updated:** January 15, 2026
**Status:** Planning phase, v1.0.0 just released
