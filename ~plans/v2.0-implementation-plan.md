# Poppy v2.0 Implementation Plan

**Created:** January 15, 2026
**Target Release:** Q4 2026
**Current Version:** 1.0.0

---

## 🎯 Vision

Poppy v2.0 will expand from a 3-platform compiler (NES, SNES, Game Boy) to support 12+ retro gaming platforms, making it the most comprehensive multi-platform retro assembly toolchain available.

---

## 📊 Platform Priority Matrix

### Priority Calculation

Priority is based on:
1. **Community Size** - Active homebrew developers
2. **Implementation Complexity** - Development time and difficulty
3. **Architectural Diversity** - New instruction sets add more value
4. **Synergy** - Compatibility with existing platforms

### Platform Rankings

| Platform | CPU | Priority | Est. Time | Complexity | Community |
|----------|-----|----------|-----------|------------|-----------|
| **SNES SPC700** | SPC700 | ⭐⭐⭐⭐⭐ | 4-6 weeks | Medium | High |
| **Sega Genesis** | 68000 | ⭐⭐⭐⭐⭐ | 6-8 weeks | Med-High | Very High |
| **Game Boy Advance** | ARM7TDMI | ⭐⭐⭐⭐⭐ | 8-10 weeks | High | Very High |
| **Atari 2600** | 6507 | ⭐⭐⭐⭐ | 2-3 weeks | Low-Med | High |
| **Sega Master System** | Z80 | ⭐⭐⭐⭐ | 4-5 weeks | Medium | Medium |
| **TurboGrafx-16** | HuC6280 | ⭐⭐⭐ | 3-4 weeks | Low-Med | Medium |
| **WonderSwan** | V30MZ | ⭐⭐ | 6-8 weeks | Med-High | Low-Med |
| **Atari Lynx** | 65SC02 | ⭐⭐ | 2-3 weeks | Low | Low-Med |
| **Game Boy Color** | SM83 | ⭐⭐⭐⭐ | 1-2 weeks | Very Low | High |

---

## 🏗️ Development Phases

### Phase 1: Foundation (v2.0 Alpha) - Q1 2026

**Goal:** Implement first 3 new platforms with highest impact

**Platforms:**
1. ✅ **Game Boy Color** (1-2 weeks)
   - Already 95% compatible with Game Boy
   - Add CGB-specific features (color palettes, double-speed mode)
   - Minimal new code required

2. 🔧 **SNES SPC700** (4-6 weeks)
   - Complements existing SNES 65816 support
   - New instruction set (SPC700)
   - DSP register handling
   - BRR sample format support

3. 🔧 **Sega Genesis** (6-8 weeks)
   - Motorola 68000 (new architecture family)
   - Big-endian byte order
   - Complex addressing modes
   - VDP/Z80 subsystem awareness

**Deliverables:**
- [ ] Game Boy Color target fully functional
- [ ] SPC700 instruction set implementation
- [ ] 68000 instruction set implementation
- [ ] Updated documentation for all 3 platforms
- [ ] Example projects for each
- [ ] Test suite coverage

**Timeline:** 11-16 weeks (March-April 2026)

---

### Phase 2: Expansion (v2.0 Beta) - Q2 2026

**Goal:** Add medium-priority platforms with manageable complexity

**Platforms:**
1. 🔧 **Atari 2600** (2-3 weeks)
   - 6507 (6502 variant)
   - Bank switching support
   - TIA/RIOT register sets
   - Minimal RAM constraints

2. 🔧 **Sega Master System** (4-5 weeks)
   - Z80 instruction set
   - VDP/PSG handling
   - Banking support
   - Shared with Game Gear

3. 🔧 **TurboGrafx-16** (3-4 weeks)
   - HuC6280 (65C02 + extensions)
   - Block transfer instructions
   - VDC/VCE/PSG support
   - Memory page mapping

**Deliverables:**
- [ ] Atari 2600 target complete
- [ ] Z80 instruction set implementation
- [ ] HuC6280 instruction set implementation
- [ ] Documentation for all 3 platforms
- [ ] Example projects
- [ ] Test coverage

**Timeline:** 9-12 weeks (May-June 2026)

---

### Phase 3: ARM Architecture (v2.0 RC1) - Q3 2026

**Goal:** Implement Game Boy Advance and ARM architecture

**Platforms:**
1. 🔧 **Game Boy Advance** (8-10 weeks)
   - ARM7TDMI (32-bit ARM + 16-bit Thumb)
   - Dual instruction set support
   - ROM header generation
   - BIOS calls
   - Advanced features (DMA, timers, interrupts)

**Deliverables:**
- [ ] ARM instruction set (32-bit) implementation
- [ ] Thumb instruction set (16-bit) implementation
- [ ] ARM/Thumb mode switching
- [ ] GBA-specific features
- [ ] Comprehensive documentation
- [ ] Multiple example projects
- [ ] Full test coverage

**Timeline:** 8-10 weeks (July-August 2026)

---

### Phase 4: Advanced Platforms (v2.0 RC2) - Q3-Q4 2026

**Goal:** Add remaining platforms for completeness

**Platforms:**
1. 🔧 **WonderSwan** (6-8 weeks)
   - NEC V30MZ (80186 compatible)
   - x86 architecture variant
   - Segment:offset addressing
   - WonderSwan Color support

2. 🔧 **Atari Lynx** (2-3 weeks)
   - 65SC02
   - Mikey/Suzy coprocessors
   - Sprite control blocks
   - Audio channels

**Deliverables:**
- [ ] V30MZ/80186 instruction set
- [ ] x86 segment addressing
- [ ] 65SC02 implementation
- [ ] Lynx-specific features
- [ ] Documentation
- [ ] Example projects
- [ ] Test coverage

**Timeline:** 8-11 weeks (September-October 2026)

---

## 🔧 Technical Implementation Details

### New Instruction Set Architectures

1. **Motorola 68000** (Genesis)
   - 32-bit registers, 16-bit data bus
   - 14 addressing modes
   - Big-endian byte order
   - No instruction prefixes
   - Condition code register

2. **ARM7TDMI** (GBA)
   - 32-bit RISC architecture
   - Dual instruction sets (ARM/Thumb)
   - Conditional execution on all instructions
   - Load/store architecture
   - Barrel shifter integration

3. **Z80** (Master System)
   - 8-bit accumulator architecture
   - Register pairs (BC, DE, HL)
   - Index registers (IX, IY)
   - Alternate register set (shadow registers)
   - Complex instruction encoding

4. **SPC700** (SNES audio)
   - 8-bit accumulator
   - Direct page addressing
   - Bit manipulation instructions
   - Block transfer operations
   - Memory-to-memory operations

5. **V30MZ** (WonderSwan)
   - 80186-compatible
   - Segment:offset addressing
   - 16-bit operations
   - x86 instruction encoding
   - Little-endian

### Code Generation Challenges

#### Big-Endian Support (Genesis)
```
Current: All platforms little-endian
New: Need endianness selection
Impact: ROM generation, word/long directives
```

#### Multi-Instruction-Set Support (GBA)
```
Current: One instruction set per platform
New: ARM + Thumb switching mid-code
Impact: Parser, code generator, mode tracking
```

#### Segment Addressing (WonderSwan)
```
Current: Flat address space
New: Segment:offset calculation
Impact: Addressing modes, linker, relocation
```

---

## 📦 Poppy.Core Architecture Changes

### New Modules

```
Poppy.Core/
├── CodeGen/
│   ├── M68000CodeGenerator.cs      # Genesis
│   ├── ARMCodeGenerator.cs         # GBA
│   ├── ThumbCodeGenerator.cs       # GBA Thumb mode
│   ├── Z80CodeGenerator.cs         # Master System
│   ├── SPC700CodeGenerator.cs      # SNES audio
│   ├── V30MZCodeGenerator.cs       # WonderSwan
│   └── HuC6280CodeGenerator.cs     # TurboGrafx-16
├── Lexer/
│   ├── InstructionSetDatabase.cs   # Centralized ISA definitions
│   └── EndianessHandler.cs         # Big/little-endian support
├── Parser/
│   ├── SegmentAddressingParser.cs  # x86 segment:offset
│   └── MultiModeParser.cs          # ARM/Thumb switching
└── ROM/
    ├── GenesisROMBuilder.cs
    ├── GBAROMBuilder.cs
    ├── SMSROMBuilder.cs
    ├── SPCFileBuilder.cs           # SPC700 format
    ├── WSROMBuilder.cs
    └── LynxROMBuilder.cs
```

### Shared Infrastructure

```csharp
public enum Endianness {
	Little,
	Big
}

public interface IInstructionSet {
	string Name { get; }
	InstructionSetFamily Family { get; }
	Endianness ByteOrder { get; }
	int AddressWidth { get; }
	bool SupportsMultipleModes { get; }
	IEnumerable<Instruction> GetInstructions();
}

public enum InstructionSetFamily {
	MOS6502,      // 6502, 65C02, 65SC02, 6507
	MOS65816,     // 65816
	M68K,         // 68000, 68010, 68020
	ARM,          // ARM7TDMI
	Z80,          // Z80, Z80A
	x86,          // V30MZ, 80186
	Custom        // SPC700, HuC6280, SM83
}
```

---

## 🧪 Testing Strategy

### Per-Platform Test Requirements

Each new platform needs:

1. **Instruction Set Tests** (500+ tests per ISA)
   - Every instruction with all addressing modes
   - Edge cases (zero page wrapping, carry flags, etc.)
   - Illegal instruction handling

2. **ROM Generation Tests** (20+ tests per platform)
   - Header format verification
   - Checksum calculation
   - Vector table placement
   - Banking configuration

3. **Integration Tests** (10+ per platform)
   - Complete "Hello World" programs
   - Sprite rendering demos
   - Sound output demos
   - Controller input reading

4. **Cross-Platform Tests**
   - Endianness consistency
   - Common directive handling
   - Macro expansion

### Automated Testing

```
Target: 95%+ code coverage for all new code
Continuous Integration: GitHub Actions
Test Frameworks: xUnit (C#), custom ROM validators
```

---

## 📚 Documentation Requirements

### Per-Platform Documentation

Each platform needs:

1. **Quick Start Guide** (1-2 pages)
   - Installation
   - First program
   - Building and running

2. **Syntax Reference** (10-20 pages)
   - Instruction set overview
   - Addressing modes
   - Directives
   - Macros

3. **Hardware Reference** (10-30 pages)
   - Memory map
   - I/O registers
   - Graphics/sound systems
   - Interrupt handling

4. **Migration Guide** (5-10 pages)
   - From existing assemblers (ASAR, ca65, etc.)
   - Syntax differences
   - Feature comparisons

5. **Example Projects** (3-5 per platform)
   - Hello world
   - Graphics demo
   - Sound demo
   - Controller input
   - Complete mini-game

---

## 🔄 Backwards Compatibility

### v1.x Compatibility Guarantee

- All v1.0 .pasm files must compile unchanged in v2.0
- Existing NES, SNES, Game Boy projects fully supported
- No breaking changes to core syntax
- New platforms as additive features only

### Deprecation Policy

- Deprecated features get 2 minor versions warning
- Clear migration paths documented
- Automated migration tools where possible

---

## 🚀 Release Strategy

### Version Numbering

```
v2.0.0-alpha.1    # Phase 1 complete (GBC, SPC700, Genesis)
v2.0.0-alpha.2    # Alpha refinements
v2.0.0-beta.1     # Phase 2 complete (2600, SMS, TG16)
v2.0.0-beta.2     # Beta refinements
v2.0.0-rc.1       # Phase 3 complete (GBA)
v2.0.0-rc.2       # Phase 4 complete (WS, Lynx)
v2.0.0            # Final release
```

### Release Criteria

**Alpha Release:**
- 6 platforms total (3 original + 3 new)
- All new platforms have working code generation
- Basic documentation for new platforms
- Example projects compile and run

**Beta Release:**
- 9 platforms total
- All platforms have comprehensive tests
- Documentation complete
- Migration guides written

**RC Release:**
- 11 platforms total
- All tests passing
- Performance optimizations complete
- VS Code extension updated

**Final Release:**
- All planned platforms implemented
- Zero known critical bugs
- Complete documentation
- Published to GitHub releases
- VS Code extension published

---

## 📊 Success Metrics

### Technical Metrics

- **Platforms Supported:** 11+ (up from 3)
- **Instruction Sets:** 8+ unique ISAs
- **Test Coverage:** 95%+ for new code
- **Build Time:** <5 seconds for 100KB ROM
- **Documentation:** 100+ pages total

### Community Metrics

- **GitHub Stars:** 500+ (from current ~50)
- **Downloads:** 1,000+ per month
- **Community Projects:** 50+ homebrew games using Poppy v2.0
- **Contributors:** 10+ active contributors

---

## 🛣️ Beyond v2.0 - Future Platforms

### Candidate Platforms for v2.1+

- **Neo Geo Pocket Color** (TLCS-900H)
- **Sega Game Gear** (Z80, similar to SMS)
- **Atari 7800** (6502 + MARIA)
- **ColecoVision** (Z80)
- **Intellivision** (CP1610)
- **Vectrex** (6809)
- **MSX** (Z80)
- **ZX Spectrum** (Z80)

### Modern Platforms

- **PICO-8** (Fantasy console)
- **TIC-80** (Fantasy console)
- **Pokitto** (ARM Cortex-M0+)

---

## 📅 Timeline Summary

| Phase | Duration | Platforms | Target Date |
|-------|----------|-----------|-------------|
| Phase 1 | 11-16 weeks | GBC, SPC700, Genesis | April 2026 |
| Phase 2 | 9-12 weeks | 2600, SMS, TG16 | June 2026 |
| Phase 3 | 8-10 weeks | GBA | August 2026 |
| Phase 4 | 8-11 weeks | WonderSwan, Lynx | October 2026 |
| **Total** | **36-49 weeks** | **8 new platforms** | **Q4 2026** |

---

## 💰 Resource Requirements

### Development Time

- Lead developer: 36-49 weeks full-time equivalent
- Testing/QA: 10-15 weeks
- Documentation: 8-12 weeks
- **Total:** ~60-75 weeks of work

### Infrastructure

- CI/CD pipeline (GitHub Actions - free for public repos)
- Emulator collection for testing
- ROM testing tools
- Documentation hosting (GitHub Pages - free)

---

## ✅ Go/No-Go Criteria

### Proceed with v2.0 if:

- ✅ v1.0 is stable and well-received
- ✅ Community shows interest (GitHub stars, forum activity)
- ✅ Development resources available (time, contributors)
- ✅ Reference documentation accessible for target platforms
- ✅ Emulators available for testing

### Reconsider if:

- ❌ v1.0 has major unresolved bugs
- ❌ No community adoption
- ❌ Insufficient development time
- ❌ Platforms lack adequate documentation
- ❌ No reliable emulators for testing

---

## 🎯 Current Status: READY TO BEGIN

**Decision:** Proceed with v2.0 development
**Start Date:** January 2026
**First Milestone:** Game Boy Color support (2 weeks)
**Next Milestone:** SPC700 implementation (6 weeks)

---

*This document is a living plan and will be updated as development progresses.*
